<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイムナビ (25分固定・シンプル版)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" />

    <style>
        /* ベーススタイル */
        html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; overscroll-behavior: none; }
        #map { height: 100%; width: 100%; }
        
        /* ジェスチャー用オーバーレイ */
        #gesture-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: transparent; display: none; cursor: ew-resize; touch-action: none; }
        
        /* メニューコンテナ */
        #right-menu-container { position: absolute; top: 10px; right: 10px; z-index: 200; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; max-height: 90%; }
        .icon-button { background-color: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); width: 50px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #555; transition: background-color 0.2s; }
        .icon-button:active { background-color: #f0f0f0; }
        
        /* メニュー中身 */
        #menu-content { display: none; flex-direction: column; gap: 10px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); min-width: 220px; overflow-y: auto; max-height: 80vh; }
        .menu-section { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 5px; }
        .menu-section:last-child { border-bottom: none; }
        .menu-label { font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; display: block; }
        #menu-content button { padding: 10px; border-radius: 4px; border: none; cursor: pointer; width: 100%; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); background-color: white; border: 1px solid #eee; margin-bottom: 5px; }

        /* 固定設定コントロール */
        #slider-lock-controls { display: flex; align-items: center; justify-content: space-between; gap: 5px; font-size: 13px; flex-wrap: nowrap; }
        #slider-lock-controls input[type="number"] { width: 50px; padding: 4px; text-align: right; border: 1px solid #ccc; border-radius: 3px; }
        #slider-lock-controls select { padding: 4px; border: 1px solid #ccc; border-radius: 3px; }
        
        /* ナビパネル (検索窓など) */
        #nav-panel { position: absolute; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 5px; z-index: 200; display: flex; gap: 10px; align-items: flex-start; flex-wrap: wrap; box-sizing: border-box; max-width: 90%; }
        #search-controls { display: none; gap: 10px; flex-direction: column; width: 300px; max-width: 100%; }
        #destination-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #nav-panel button { padding: 8px 12px; border-radius: 4px; border: none; background-color: #4285F4; color: white; cursor: pointer; white-space: nowrap; }

        /* スライダー本体 */
        #route-slider-container { position: absolute; bottom: 30px; left: 10px; right: 10px; background: transparent; padding: 0; z-index: 201; display: none; box-sizing: border-box; }
        #route-slider { margin: 0 15px; height: 12px; box-shadow: 0 0 5px rgba(0,0,0,0.3); border: 1px solid #fff; }
        .noUi-connect { background: #4285F4; }
        
        /* アクティブボタン */
        button.active-mode { background-color: #E91E63 !important; color: white !important; }

        /* 凡例 */
        #legend { font-size: 11px; color: #555; display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .legend-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 3px; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="gesture-overlay"></div>
    
    <div id="right-menu-container">
        <button id="compass-button" class="icon-button" title="現在地追従 / 進行方向を上にする">
            <svg id="compass-svg" viewBox="0 0 24 24" width="24" height="24" style="transition: transform 0.3s ease;">
                <polygon points="12,3 16,11 8,11" fill="#FF5252"></polygon>
                <polygon points="12,21 16,11 8,11" fill="#9E9E9E"></polygon>
                <circle cx="12" cy="12" r="2" fill="white"></circle>
            </svg>
        </button>

        <button id="demo-nav-view-button" class="icon-button" title="ナビ視点へ切替">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="#4285F4">
                <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
            </svg>
        </button>

        <button id="menu-toggle-button" class="icon-button">☰</button>
        
        <div id="menu-content">
            <div class="menu-section">
                <span class="menu-label">映像再現モード</span>
                <button id="start-video-sim-button" style="background-color: #E91E63; color: white;">映像再現開始 (25分)</button>
            </div>

            <div class="menu-section" id="route-info-section" style="display: none;">
                <span class="menu-label">範囲固定設定</span>
                <div id="slider-lock-controls">
                    <input type="number" id="lock-value" placeholder="0" min="1" value="5">
                    <select id="lock-unit">
                        <option value="none">なし</option>
                        <option value="min" selected>分 (全体25分)</option>
                        <option value="km">km</option>
                    </select>
                </div>
                <div id="legend">
                    <div><span class="legend-dot" style="background-color: #FF0000;"></span>一般道</div>
                    <div><span class="legend-dot" style="background-color: #9C27B0;"></span>高速/有料</div>
                </div>
            </div>

            <div class="menu-section">
                <span class="menu-label">地図操作</span>
                <div style="display:flex; gap:5px;">
                    <button id="tilt-up-button">視点 ▲</button>
                    <button id="tilt-down-button">視点 ▼</button>
                </div>
            </div>
            
             <div class="menu-section">
                <span class="menu-label">ナビ操作</span>
                <button id="start-tracking-button" style="display: none; background-color: #34A853; color: white;">ナビ開始</button>
                <button id="enable-orientation-button" style="display: none; background-color: #666; color: white;">コンパス有効化</button>
            </div>
        </div>
    </div>

    <div id="nav-panel">
        <button id="toggle-search-button">検索</button>
        <button id="toggle-gesture-mode" style="display:none; background-color: #673AB7;">全画面操作</button>
        
        <div id="search-controls"> 
            <input type="text" id="destination-input" placeholder="目的地を入力">
            <div style="display:flex; gap:10px; margin-top:5px;">
                <button id="start-nav-button">経路検索</button>
                <button id="clear-route-button" style="background-color: #f44336;">クリア</button>
            </div>
        </div>
    </div>

    <div id="route-slider-container">
        <div id="route-slider"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

    <script>
        // ★★★ APIキー (ご自身のものを使用) ★★★
        const API_KEY = "AIzaSyBZMrPm3iUtrr4f8Bzrw6yboDilUX3aZCM"; 
        const LIGHT_MAP_ID = "e0361908272b781aef2d6849"; 
        const DARK_MAP_ID = "e0361908272b781aef2d6849";

        // ★設定: 全体の所要時間を25分に固定
        const TOTAL_DURATION_MINUTES = 25;
        const TOTAL_DURATION_SECONDS = TOTAL_DURATION_MINUTES * 60;

        let map;
        let directionsService;
        let directionsRenderer;
        let geocoder;
        let threeDBuildingLayer;
        
        let currentPositionMarker;
        let currentLatLng;
        let destinationMarker;
        
        let routePath = [];
        let routeSteps = [];

        let cumulativeDistances = [];
        let cumulativeDurations = []; 
        let totalRouteDistance = 0;
        
        let highlightPolylines = []; 
        let bluePolyline; 
        let routeSlider, sliderContainer;
        
        let isTrackingMode = false;
        let isGestureMode = false;
        let isDragging = false; 

        // 自動でカメラが現在地を追従するかどうかのフラグ
        let isAutoCameraTracking = true; 

        const DEFAULT_TILT = 60;
        const NAV_TILT = 70; 

        let isVideoSimMode = false;
        let animationFrameId = null;
        let simStartTimeStamp = 0;   
        const SIM_START_TIME = 300; 
        const SIM_END_TIME = 1800;  
        const SIM_DURATION = SIM_END_TIME - SIM_START_TIME; 

        function initMap() {
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            geocoder = new google.maps.Geocoder();
            
            const initialPosition = { lat: 35.681236, lng: 139.767125 }; 
            map = new google.maps.Map(document.getElementById('map'), {
                center: initialPosition,
                zoom: 18,
                tilt: DEFAULT_TILT, 
                heading: 0,
                mapId: LIGHT_MAP_ID,
                disableDefaultUI: true,
                gestureHandling: 'greedy'
            });

            // 手動で地図をドラッグした場合、自動追従を解除
            map.addListener('dragstart', () => {
                isAutoCameraTracking = false;
            });

            try {
                if (google && google.maps && typeof google.maps.ThreeDBuildingLayer === 'function') {
                    threeDBuildingLayer = new google.maps.ThreeDBuildingLayer();
                    threeDBuildingLayer.setMap(map);
                }
            } catch (err) { console.error("3D Layer Error:", err); }

            const trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);
            
            directionsRenderer.setOptions({ suppressPolylines: true, suppressMarkers: true, map: map });

            currentPositionMarker = new google.maps.Marker({
                map: map,
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 7,
                    fillColor: '#4285F4',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: 'white',
                    rotation: 0 
                }
            });

            setupDayNightMode();
            setupMenu(); 
            setupButtons(); 
            setupSliders(); 
            setupLockControls(); 
            setupGestureControls(); 
            setupCompass();
            setupOrientationControls(); 
            setupVideoSimulation();
            
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        if (isVideoSimMode) return; 
                        
                        // ★修正: 第3引数に position.coords.heading を渡す
                        updatePositionLogic(
                            position.coords.latitude, 
                            position.coords.longitude,
                            position.coords.heading
                        );
                    },
                    (e) => console.warn(e), { enableHighAccuracy: true }
                );
            }

            loadGeoJsonRoute();
        }

        // ==========================================
        // ★ ジェスチャー操作
        // ==========================================
        function setupGestureControls() {
            const gestureBtn = document.getElementById('toggle-gesture-mode');
            const overlay = document.getElementById('gesture-overlay');

            gestureBtn.addEventListener('click', () => {
                isGestureMode = !isGestureMode;
                if (isGestureMode) {
                    gestureBtn.textContent = '操作終了';
                    gestureBtn.classList.add('active-mode');
                    overlay.style.display = 'block';
                    document.getElementById('search-controls').style.display = 'none';
                } else {
                    gestureBtn.textContent = '全画面操作';
                    gestureBtn.classList.remove('active-mode');
                    overlay.style.display = 'none';
                    isDragging = false;
                }
            });

            let startX = 0, startY = 0; 
            let startWidth = 0, startCenter = 0;  

            const STEP_DISTANCE = 5000; 
            const MIN_WIDTH = 1000;     
            const PIXELS_PER_STEP = 50; 

            const handleStart = (clientX, clientY) => {
                if (!routeSlider || routePath.length === 0) return;
                isDragging = true; 
                isAutoCameraTracking = false; 

                startX = clientX;
                startY = clientY;
                const vals = routeSlider.get();
                const currentStart = parseFloat(vals[0]);
                const currentEnd = parseFloat(vals[1]);
                startWidth = currentEnd - currentStart;
                startCenter = (currentStart + currentEnd) / 2;
            };

            const handleMove = (clientX, clientY) => {
                if (!isDragging || !routeSlider) return;

                const maxMeters = totalRouteDistance; 
                const screenWidth = window.innerWidth;

                const deltaY = clientY - startY;
                const steps = Math.round(-deltaY / PIXELS_PER_STEP); 
                const widthChange = steps * STEP_DISTANCE; 
                let newWidth = startWidth + widthChange;
                if (newWidth < MIN_WIDTH) newWidth = MIN_WIDTH;
                if (newWidth > maxMeters) newWidth = maxMeters;

                const deltaX = clientX - startX;
                const moveSensitivity = 1.5;
                const moveMeters = (deltaX / screenWidth) * maxMeters * moveSensitivity;
                let newCenter = startCenter + moveMeters;

                let newStart = newCenter - (newWidth / 2);
                let newEnd = newCenter + (newWidth / 2);

                if (newStart < 0) {
                    const diff = 0 - newStart;
                    newStart = 0;
                    newEnd += diff;
                }
                if (newEnd > maxMeters) {
                    const diff = newEnd - maxMeters;
                    newEnd = maxMeters;
                    newStart -= diff;
                    if (newStart < 0) newStart = 0;
                }

                routeSlider.set([newStart, newEnd]);
                updateRouteHighlight([newStart, newEnd], true); 
            };

            const handleEnd = () => { isDragging = false; };

            overlay.addEventListener('touchstart', (e) => { if (e.touches.length === 1) handleStart(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
            overlay.addEventListener('touchmove', (e) => { if (e.touches.length === 1) { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); } }, { passive: false });
            overlay.addEventListener('touchend', handleEnd);
            overlay.addEventListener('mousedown', (e) => handleStart(e.clientX, e.clientY));
            window.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY));
            window.addEventListener('mouseup', handleEnd);
        }

        // ==========================================
        // ★ コンパス・方位系処理
        // ==========================================
        function setupOrientationControls() {
            const permissionButton = document.getElementById('enable-orientation-button');
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                permissionButton.style.display = 'block';
                permissionButton.addEventListener('click', () => {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation);
                                permissionButton.style.display = 'none'; 
                                alert("コンパスを有効化しました");
                            } else {
                                alert('コンパス許可が拒否されました。');
                            }
                        }).catch(console.error);
                });
            } else if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            const heading = event.webkitCompassHeading || event.alpha; 
            if (heading !== null && currentPositionMarker) {
                const icon = currentPositionMarker.getIcon();
                icon.rotation = heading;
                currentPositionMarker.setIcon(icon);
            }
        }

        function getRouteHeading(position) {
            if (routePath.length < 2) return 0;
            let minD = Infinity;
            let nearestIdx = 0;
            for (let i = 0; i < routePath.length - 1; i++) {
                const d = google.maps.geometry.spherical.computeDistanceBetween(position, routePath[i]);
                if (d < minD) { minD = d; nearestIdx = i; }
            }
            let p1 = routePath[nearestIdx];
            let p2 = routePath[nearestIdx + 1];
            if (!p2) {
                p1 = routePath[nearestIdx - 1];
                p2 = routePath[nearestIdx];
            }
            if (p1 && p2) {
                return google.maps.geometry.spherical.computeHeading(p1, p2);
            }
            return 0;
        }

        function setupCompass() {
             const btn = document.getElementById('compass-button');
             const svg = document.getElementById('compass-svg');
             map.addListener('heading_changed', () => {
                 svg.style.transform = `rotate(${-map.getHeading()}deg)`;
             });
             
             btn.addEventListener('click', () => {
                 isAutoCameraTracking = true; 
                 if (currentLatLng) {
                     let heading = 0;
                     if (routePath.length > 0) {
                         heading = getRouteHeading(currentLatLng);
                     }
                     map.moveCamera({ 
                         center: currentLatLng,
                         zoom: 18, 
                         tilt: NAV_TILT,
                         heading: heading 
                     });
                 } else {
                     map.moveCamera({ heading: 0, tilt: DEFAULT_TILT });
                 }
             });
        }

        // ==========================================
        // ★ スライダー＆ハイライト
        // ==========================================
        function setupSliders() { sliderContainer = document.getElementById('route-slider-container'); }

        function createSlider() {
            const sliderElement = document.getElementById('route-slider');
            if (routeSlider) { routeSlider.destroy(); }
            
            routeSlider = noUiSlider.create(sliderElement, {
                start: [0, totalRouteDistance],
                connect: true, 
                range: { 'min': 0, 'max': totalRouteDistance }, 
                step: 10, 
                animate: false,
                behaviour: 'drag' 
            });
            
            routeSlider.on('start', () => {
                isAutoCameraTracking = false;
            });

            routeSlider.on('slide', (values) => {
                updateRouteHighlight(values, true);
            });
            
            routeSlider.on('change', (values) => {
                updateRouteHighlight(values, false);
            });
            
            // 初期表示
            updateRouteHighlight([0, totalRouteDistance], true);
        }

        // ★変更点: 範囲固定の計算ロジック (25分基準に変更)
        function handleRangeLock(changedHandle, values) {
            const lockValue = parseFloat(document.getElementById('lock-value').value);
            const lockUnit = document.getElementById('lock-unit').value;
            
            if (!lockValue || lockUnit === 'none') return null;

            const startMeters = parseFloat(values[0]);
            const endMeters = parseFloat(values[1]);
            const maxMeters = totalRouteDistance;
            let distMeters = 0;

            if (lockUnit === 'min') {
                // ★ 変更: 全体(25分)に対する割合で距離を算出
                // (指定分数 / 25) * 全距離
                distMeters = (lockValue / TOTAL_DURATION_MINUTES) * totalRouteDistance;
            } else {
                // km単位はそのまま距離
                distMeters = lockValue * 1000;
            }
            
            if (changedHandle === 0) { 
                 let targetEndMeters = startMeters + distMeters;
                 let newStart = startMeters;
                 let newEnd = targetEndMeters;
                 if (newEnd > maxMeters) {
                     newEnd = maxMeters;
                     newStart = maxMeters - distMeters;
                     if (newStart < 0) newStart = 0;
                 }
                 return [newStart, newEnd];
            } else { 
                 let targetStartMeters = endMeters - distMeters;
                 let newStart = targetStartMeters;
                 let newEnd = endMeters;
                 if (newStart < 0) {
                     newStart = 0;
                     newEnd = distMeters;
                     if (newEnd > maxMeters) newEnd = maxMeters;
                 }
                 return [newStart, newEnd];
            }
        } 
        
        function setupLockControls() {
            const lockInput = document.getElementById('lock-value');
            const unitSelect = document.getElementById('lock-unit');
            const applyLockToSlider = () => {
                if (!routeSlider || routePath.length === 0) return;
                const currentValues = routeSlider.get();
                const startMeters = parseFloat(currentValues[0]);
                const fixedValues = handleRangeLock(0, [startMeters, startMeters]); 
                if (fixedValues) {
                    routeSlider.set(fixedValues);
                    updateRouteHighlight(fixedValues, false); 
                }
            };
            lockInput.addEventListener('input', applyLockToSlider);
            unitSelect.addEventListener('change', applyLockToSlider);
        }

        function isHighwayStep(step) {
            const instr = (step.instructions || "").replace(/<[^>]*>/g, ""); 
            const maneuver = step.maneuver || ""; 
            if (maneuver.includes("merge") || maneuver.includes("ramp") || maneuver.includes("ferry")) return true;
            if (instr.includes("JCT") || instr.includes("有料道路") || instr.includes("都市高")) return true;
            if ((instr.includes("高速") || instr.includes("自動車道") || instr.includes("IC") || instr.includes("スマートIC")) && !instr.includes("方面") && !instr.includes("入口")) return true;
            return false;
        }

        function updateRouteHighlight(values, shouldFitBounds = true) {
            if (routePath.length === 0) return;
            
            const startMeters = parseFloat(values[0]);
            const endMeters = parseFloat(values[1]);
            
            // ★ 情報表示関数の呼び出しは削除しました (HTML要素削除に伴い)

            const diffMeters = endMeters - startMeters;
            const lockInput = document.getElementById('lock-value');
            const lockUnit = document.getElementById('lock-unit').value;
            
            // 入力欄への反映
            if (lockInput && lockUnit !== 'none') {
                if (lockUnit === 'min') {
                    // ★ 変更: 距離割合から分数を逆算 (距離 / 全距離 * 25)
                    const mins = (diffMeters / totalRouteDistance) * TOTAL_DURATION_MINUTES;
                    lockInput.value = Math.round(mins);
                } else {
                    lockInput.value = (diffMeters / 1000).toFixed(1);
                }
            }

            const sliderStartIdx = findIndexByDistance(startMeters);
            const sliderEndIdx = findIndexByDistance(endMeters);

            if (sliderStartIdx > sliderEndIdx) return;

            highlightPolylines.forEach(p => p.setMap(null));
            highlightPolylines = [];

            if (routeSteps && routeSteps.length > 0) {
                routeSteps.forEach(step => {
                    const stepStart = step.startPathIndex;
                    const stepEnd = step.endPathIndex;
                    const drawStart = Math.max(sliderStartIdx, stepStart);
                    const drawEnd = Math.min(sliderEndIdx, stepEnd);

                    if (drawStart < drawEnd) {
                        const segmentPath = routePath.slice(drawStart, drawEnd + 1);
                        const color = isHighwayStep(step) ? '#9C27B0' : '#FF0000';
                        const zIndex = isHighwayStep(step) ? 10 : 9;

                        const poly = new google.maps.Polyline({
                            path: segmentPath,
                            geodesic: true,
                            strokeColor: color,
                            strokeOpacity: 1.0,
                            strokeWeight: 12,
                            zIndex: zIndex
                        });
                        poly.setMap(map);
                        highlightPolylines.push(poly);
                    }
                });
            } else {
                const segmentPath = routePath.slice(sliderStartIdx, sliderEndIdx + 1);
                if (segmentPath.length > 1) {
                    const poly = new google.maps.Polyline({
                        path: segmentPath,
                        geodesic: true,
                        strokeColor: '#FF0000', 
                        strokeOpacity: 1.0, 
                        strokeWeight: 12, 
                        zIndex: 10
                    });
                    poly.setMap(map);
                    highlightPolylines.push(poly);
                }
            }
            
            if (shouldFitBounds) { 
                const bounds = new google.maps.LatLngBounds();
                for (let i = sliderStartIdx; i <= sliderEndIdx; i++) {
                    bounds.extend(routePath[i]);
                }
                
                if (!isAutoCameraTracking) {
                    const currentTilt = map.getTilt();
                    map.fitBounds(bounds, { top: 100, bottom: 150, left: 30, right: 30 }); 
                    map.setTilt(currentTilt);
                }
            }
        }

        // ==========================================
        // ★ 映像再現シミュレーション
        // ==========================================
        function setupVideoSimulation() {
            const simButton = document.getElementById('start-video-sim-button');
            simButton.addEventListener('click', () => {
                if (isVideoSimMode) stopVideoSimulation();
                else startVideoSimulation();
            });
        }

        function startVideoSimulation() {
            if (routePath.length < 2) { alert("ルートなし"); return; }
            isVideoSimMode = true;
            document.getElementById('start-video-sim-button').textContent = "再現停止";
            document.getElementById('start-video-sim-button').style.backgroundColor = "#666";
            
            if (!isTrackingMode) document.getElementById('start-tracking-button').click();
            
            isAutoCameraTracking = true;

            const progress = 0; 
            const targetDist = totalRouteDistance * progress; 
            updateSimulationPosition(targetDist); 

            simStartTimeStamp = performance.now();
            loopSimulation();
        }

        function loopSimulation() {
            if (!isVideoSimMode) return;
            const now = performance.now();
            const elapsedSec = (now - simStartTimeStamp) / 1000;
            if (elapsedSec > SIM_DURATION) { stopVideoSimulation(); return; }

            const progress = elapsedSec / SIM_DURATION;
            const targetDist = totalRouteDistance * progress;

            updateSimulationPosition(targetDist);
            animationFrameId = requestAnimationFrame(loopSimulation);
        }

        function updateSimulationPosition(targetDist) {
            let idx = cumulativeDistances.findIndex(d => d >= targetDist);
            if (idx <= 0) idx = 1;
            if (idx >= routePath.length) idx = routePath.length - 1;

            const prevIndex = idx - 1;
            const nextIndex = idx;
            const segmentDist = cumulativeDistances[nextIndex] - cumulativeDistances[prevIndex];
            
            let fraction = 0;
            if (segmentDist > 0) {
                fraction = (targetDist - cumulativeDistances[prevIndex]) / segmentDist;
            }

            const interpolatedPos = google.maps.geometry.spherical.interpolate(
                routePath[prevIndex], routePath[nextIndex], fraction
            );
            const heading = google.maps.geometry.spherical.computeHeading(routePath[prevIndex], routePath[nextIndex]);

            currentLatLng = interpolatedPos;
            currentPositionMarker.setPosition(interpolatedPos);

            const icon = currentPositionMarker.getIcon();
            icon.rotation = heading;
            currentPositionMarker.setIcon(icon);

            if (isAutoCameraTracking && !isDragging) {
                map.moveCamera({ center: interpolatedPos, heading: heading, tilt: NAV_TILT, zoom: 18 });
            }
        }

        function stopVideoSimulation() {
            isVideoSimMode = false;
            if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
            document.getElementById('start-video-sim-button').textContent = "映像再現開始 (25分)";
            document.getElementById('start-video-sim-button').style.backgroundColor = "#E91E63";
        }

        // ==========================================
        // ★ 共通ロジック
        // ==========================================
        
  const customRouteGeoJSON = {
          "type": "FeatureCollection",
          "features": [
            {
              "type": "Feature",
              "geometry": {
                "type": "LineString",
                "coordinates": [
                  // ... GeoJSON coordinates ...
                  [139.36787, 35.73484, 0], [139.36777, 35.73477, 0], [139.36762, 35.73465, 0],
                  [139.36692, 35.73415, 0], [139.36688, 35.73411, 0], [139.36683, 35.73407, 0],
                  [139.36669, 35.73394, 0], [139.36658, 35.73385, 0], [139.36654, 35.73381, 0],
                  [139.36645, 35.7337, 0], [139.36641, 35.73364, 0], [139.36636, 35.73358, 0],
                  [139.36635, 35.73355, 0], [139.36632, 35.73351, 0], [139.3663, 35.73346, 0],
                  [139.36625, 35.73336, 0], [139.36619, 35.73313, 0], [139.36612, 35.73281, 0],
                  [139.36611, 35.73274, 0], [139.36572, 35.73098, 0], [139.36567, 35.7307, 0],
                  [139.36564, 35.73059, 0], [139.36557, 35.73016, 0], [139.3646, 35.73032, 0],
                  [139.36456, 35.73033, 0], [139.36439, 35.73035, 0], [139.36413, 35.7304, 0],
                  [139.36403, 35.73041, 0], [139.36393, 35.73043, 0], [139.36387, 35.73043, 0],
                  [139.36385, 35.73044, 0], [139.36374, 35.73044, 0], [139.36366, 35.73042, 0],
                  [139.36362, 35.73042, 0], [139.3636, 35.73041, 0], [139.36331, 35.73032, 0],
                  [139.36327, 35.7303, 0], [139.36166, 35.72977, 0], [139.36133, 35.72965, 0],
                  [139.36003, 35.72922, 0], [139.35976, 35.72912, 0], [139.35948, 35.72903, 0],
                  [139.35935, 35.72898, 0], [139.35905, 35.72888, 0], [139.35897, 35.72886, 0],
                  [139.35792, 35.72851, 0], [139.35788, 35.72849, 0], [139.35734, 35.72832, 0],
                  [139.35709, 35.72823, 0], [139.35702, 35.7282, 0], [139.35689, 35.72816, 0],
                  [139.35666, 35.72807, 0], [139.35586, 35.72771, 0], [139.35559, 35.7276, 0],
                  [139.35541, 35.72751, 0], [139.35526, 35.72746, 0], [139.35514, 35.7274, 0],
                  [139.35511, 35.72739, 0], [139.35502, 35.72734, 0], [139.35496, 35.72732, 0],
                  [139.35344, 35.72662, 0], [139.35356, 35.72645, 0], [139.35372, 35.7262, 0],
                  [139.35392, 35.72593, 0], [139.35392, 35.72591, 0], [139.35401, 35.72576, 0],
                  [139.35412, 35.72553, 0], [139.3543, 35.7252, 0], [139.35484, 35.72429, 0],
                  [139.3551, 35.72389, 0], [139.35517, 35.72375, 0], [139.35525, 35.72363, 0],
                  [139.35546, 35.72327, 0], [139.3555, 35.72321, 0], [139.35559, 35.72305, 0],
                  [139.35566, 35.72294, 0], [139.35569, 35.7229, 0], [139.35623, 35.72197, 0],
                  [139.35629, 35.72188, 0], [139.35636, 35.72175, 0], [139.35636, 35.72174, 0],
                  [139.3564, 35.72168, 0], [139.3564, 35.72167, 0], [139.35642, 35.72163, 0],
                  [139.35642, 35.7216, 0], [139.35643, 35.72155, 0], [139.35643, 35.72145, 0],
                  [139.35638, 35.72131, 0], [139.3563, 35.7212, 0], [139.35622, 35.72112, 0],
                  [139.35616, 35.72108, 0], [139.3561, 35.72105, 0], [139.35549, 35.72068, 0],
                  [139.35541, 35.72062, 0], [139.35496, 35.72035, 0], [139.35492, 35.72032, 0],
                  [139.35489, 35.72029, 0], [139.35485, 35.72027, 0], [139.35482, 35.72023, 0],
                  [139.35473, 35.72014, 0], [139.35468, 35.72006, 0], [139.35465, 35.72, 0],
                  [139.3546, 35.71988, 0], [139.35458, 35.7198, 0], [139.35456, 35.71966, 0],
                  [139.35454, 35.71959, 0], [139.35451, 35.71936, 0], [139.35441, 35.71883, 0],
                  [139.3544, 35.71872, 0], [139.35428, 35.71821, 0], [139.35426, 35.71815, 0],
                  [139.35425, 35.71809, 0], [139.35418, 35.71779, 0], [139.35396, 35.71714, 0],
                  [139.35392, 35.717, 0], [139.3537, 35.71604, 0], [139.3537, 35.71603, 0],
                  [139.35362, 35.71564, 0], [139.35361, 35.71562, 0], [139.35359, 35.71553, 0],
                  [139.35357, 35.71537, 0], [139.35357, 35.7153, 0], [139.35358, 35.71525, 0],
                  [139.35359, 35.71516, 0], [139.35361, 35.71505, 0], [139.35363, 35.71498, 0],
                  [139.35364, 35.71496, 0], [139.35366, 35.71489, 0], [139.35369, 35.71481, 0],
                  [139.35376, 35.71457, 0], [139.354, 35.71453, 0], [139.35469, 35.71435, 0],
                  [139.35495, 35.71427, 0], [139.35686, 35.71375, 0], [139.35688, 35.71374, 0],
                  [139.35798, 35.71344, 0], [139.35815, 35.71338, 0], [139.3586, 35.71327, 0],
                  [139.35805, 35.71219, 0], [139.35799, 35.7121, 0], [139.3579, 35.71193, 0],
                  [139.3578, 35.7117, 0], [139.35773, 35.71156, 0], [139.35754, 35.71123, 0],
                  [139.3575, 35.71119, 0], [139.35744, 35.71112, 0], [139.35734, 35.71102, 0],
                  [139.35728, 35.71097, 0], [139.35724, 35.71093, 0], [139.35712, 35.71085, 0],
                  [139.35708, 35.71083, 0], [139.357, 35.71078, 0], [139.35574, 35.71026, 0],
                  [139.3557, 35.71025, 0], [139.35521, 35.71005, 0], [139.35516, 35.71002, 0],
                  [139.35477, 35.70987, 0], [139.35459, 35.70979, 0], [139.35455, 35.70978, 0],
                  [139.35445, 35.70972, 0], [139.35431, 35.70962, 0], [139.35423, 35.70957, 0],
                  [139.35411, 35.70951, 0], [139.35387, 35.70936, 0], [139.35374, 35.7093, 0],
                  [139.3536, 35.70921, 0], [139.35322, 35.70901, 0], [139.35291, 35.70886, 0],
                  [139.35157, 35.70814, 0], [139.35121, 35.70796, 0], [139.35118, 35.70795, 0],
                  [139.35096, 35.70781, 0], [139.35082, 35.7077, 0], [139.35067, 35.70757, 0],
                  [139.35053, 35.7074, 0], [139.35038, 35.70715, 0], [139.35033, 35.70703, 0],
                  [139.35032, 35.70698, 0], [139.35003, 35.7063, 0], [139.35003, 35.70629, 0],
                  [139.34998, 35.70618, 0], [139.34998, 35.70616, 0], [139.34995, 35.70606, 0],
                  [139.34994, 35.70591, 0], [139.34991, 35.70582, 0], [139.34988, 35.70575, 0],
                  [139.34982, 35.70565, 0], [139.34975, 35.70549, 0], [139.34974, 35.70549, 0],
                  [139.34957, 35.70515, 0], [139.34946, 35.70495, 0], [139.34942, 35.70485, 0],
                  [139.34938, 35.70478, 0], [139.34933, 35.70467, 0], [139.34926, 35.70454, 0],
                  [139.34909, 35.70417, 0], [139.34899, 35.70399, 0], [139.34855, 35.70293, 0],
                  [139.34818, 35.70195, 0], [139.34816, 35.70188, 0], [139.34806, 35.70162, 0],
                  [139.34804, 35.70158, 0], [139.34791, 35.70123, 0], [139.34788, 35.70113, 0],
                  [139.34781, 35.70096, 0], [139.34769, 35.70059, 0], [139.34739, 35.6998, 0],
                  [139.34738, 35.69979, 0], [139.34737, 35.69976, 0], [139.34736, 35.69974, 0],
                  [139.34689, 35.69845, 0], [139.34682, 35.69828, 0], [139.34657, 35.69759, 0],
                  [139.34653, 35.6975, 0], [139.34574, 35.69538, 0], [139.34565, 35.69502, 0],
                  [139.34565, 35.69497, 0], [139.34564, 35.69493, 0], [139.34565, 35.69477, 0],
                  [139.34566, 35.69473, 0], [139.34566, 35.69467, 0], [139.34568, 35.69459, 0],
                  [139.34569, 35.69457, 0], [139.3457, 35.69452, 0], [139.34574, 35.69445, 0],
                  [139.34576, 35.6944, 0], [139.34578, 35.69437, 0], [139.34579, 35.69435, 0],
                  [139.34583, 35.69429, 0], [139.34585, 35.69425, 0], [139.34597, 35.69408, 0],
                  [139.34599, 35.69406, 0], [139.34599, 35.69405, 0], [139.3463, 35.69381, 0],
                  [139.3465, 35.6937, 0], [139.34738, 35.69334, 0], [139.34764, 35.69322, 0],
                  [139.34783, 35.69311, 0], [139.34795, 35.69303, 0], [139.34808, 35.69292, 0],
                  [139.34814, 35.69286, 0], [139.34826, 35.69271, 0], [139.3484, 35.69246, 0],
                  [139.34846, 35.69228, 0], [139.34848, 35.69215, 0], [139.34848, 35.69207, 0],
                  [139.34849, 35.69196, 0], [139.34847, 35.69182, 0], [139.34843, 35.69165, 0],
                  [139.34834, 35.69136, 0], [139.34785, 35.69008, 0], [139.34784, 35.69008, 0],
                  [139.34773, 35.68975, 0], [139.34773, 35.68973, 0], [139.3477, 35.6896, 0],
                  [139.3477, 35.68936, 0], [139.34772, 35.68916, 0], [139.34802, 35.68746, 0],
                  [139.34806, 35.68706, 0], [139.34806, 35.68695, 0], [139.34803, 35.68669, 0],
                  [139.34792, 35.68638, 0], [139.34785, 35.68623, 0], [139.34775, 35.68609, 0],
                  [139.34762, 35.68594, 0], [139.34739, 35.68571, 0], [139.34725, 35.68559, 0],
                  [139.34717, 35.6855, 0], [139.34692, 35.68528, 0], [139.34684, 35.6852, 0],
                  [139.34673, 35.68512, 0], [139.34625, 35.68468, 0], [139.34605, 35.68445, 0],
                  [139.34599, 35.68432, 0], [139.34542, 35.68361, 0], [139.3454, 35.68359, 0],
                  [139.34529, 35.68344, 0], [139.34528, 35.68342, 0], [139.34515, 35.68326, 0],
                  [139.34514, 35.68326, 0], [139.34507, 35.68317, 0], [139.34503, 35.68313, 0],
                  [139.34487, 35.68293, 0], [139.34484, 35.68288, 0], [139.34464, 35.68261, 0],
                  [139.34443, 35.68227, 0], [139.34377, 35.68106, 0], [139.34373, 35.68101, 0],
                  [139.34361, 35.68081, 0], [139.3436, 35.6808, 0], [139.34356, 35.68074, 0],
                  [139.34343, 35.68059, 0], [139.34335, 35.68051, 0], [139.34327, 35.68042, 0],
                  [139.34323, 35.68039, 0], [139.34324, 35.6803, 0], [139.34323, 35.6803, 0],
                  [139.34323, 35.68029, 0], [139.34317, 35.68023, 0], [139.34311, 35.68018, 0],
                  [139.34306, 35.68013, 0], [139.34293, 35.68002, 0], [139.34287, 35.67996, 0],
                  [139.34281, 35.67989, 0], [139.34277, 35.67983, 0], [139.34274, 35.67977, 0],
                  [139.34272, 35.67971, 0], [139.34271, 35.67963, 0], [139.34271, 35.67957, 0],
                  [139.34273, 35.67944, 0], [139.34277, 35.67936, 0], [139.34291, 35.67919, 0],
                  [139.34301, 35.67911, 0], [139.34309, 35.67906, 0], [139.34328, 35.67896, 0],
                  [139.34353, 35.67886, 0], [139.34376, 35.67879, 0], [139.34382, 35.67879, 0],
                  [139.34451, 35.67866, 0], [139.34469, 35.67864, 0], [139.34488, 35.67865, 0],
                  [139.34542, 35.67858, 0], [139.34564, 35.67856, 0], [139.3457, 35.67856, 0],
                  [139.34588, 35.67854, 0], [139.34597, 35.67854, 0], [139.34606, 35.67853, 0],
                  [139.34614, 35.67853, 0], [139.3463, 35.67851, 0], [139.3464, 35.67851, 0],
                  [139.34647, 35.6785, 0], [139.34654, 35.6785, 0], [139.3466, 35.67849, 0],
                  [139.34663, 35.67849, 0], [139.34666, 35.67848, 0], [139.34676, 35.67846, 0],
                  [139.34679, 35.67846, 0], [139.34687, 35.67843, 0], [139.34703, 35.67839, 0],
                  [139.34726, 35.67831, 0], [139.34772, 35.6781, 0], [139.34799, 35.67793, 0],
                  [139.34824, 35.67774, 0], [139.34837, 35.67762, 0], [139.34849, 35.67752, 0],
                  [139.34862, 35.67739, 0], [139.34883, 35.67715, 0], [139.34906, 35.67691, 0],
                  [139.3492, 35.67679, 0], [139.34935, 35.67668, 0], [139.34936, 35.67668, 0],
                  [139.34942, 35.67663, 0], [139.34953, 35.67657, 0], [139.34957, 35.67654, 0],
                  [139.3496, 35.67653, 0], [139.34991, 35.67638, 0], [139.34998, 35.67636, 0],
                  [139.35019, 35.67628, 0], [139.35038, 35.67622, 0], [139.35067, 35.67616, 0],
                  [139.35073, 35.67614, 0], [139.35074, 35.67614, 0], [139.35223, 35.67584, 0],
                  [139.35288, 35.67564, 0], [139.35366, 35.67549, 0], [139.35368, 35.67549, 0],
                  [139.35389, 35.67545, 0], [139.35391, 35.67545, 0], [139.354, 35.67543, 0],
                  [139.35415, 35.67541, 0], [139.3545, 35.67534, 0], [139.35459, 35.67533, 0],
                  [139.35569, 35.67513, 0], [139.35609, 35.67507, 0], [139.35612, 35.67507, 0],
                  [139.35686, 35.67496, 0], [139.3579, 35.67484, 0], [139.35792, 35.67484, 0],
                  [139.35807, 35.67482, 0], [139.3592, 35.67474, 0], [139.35926, 35.67474, 0],
                  [139.35933, 35.67473, 0], [139.3595, 35.67473, 0], [139.35985, 35.67471, 0],
                  [139.3601, 35.67471, 0], [139.36028, 35.6747, 0], [139.36077, 35.6747, 0],
                  [139.36094, 35.67471, 0], [139.36117, 35.67471, 0], [139.36205, 35.67476, 0],
                  [139.36243, 35.6748, 0], [139.3625, 35.6748, 0], [139.36352, 35.67494, 0],
                  [139.36422, 35.67507, 0], [139.36424, 35.67508, 0], [139.36466, 35.67517, 0],
                  [139.36531, 35.67533, 0], [139.36572, 35.67545, 0], [139.36579, 35.67548, 0],
                  [139.3659, 35.67551, 0], [139.36635, 35.67566, 0], [139.36705, 35.67592, 0],
                  [139.36749, 35.6761, 0], [139.36755, 35.67613, 0], [139.36811, 35.67637, 0],
                  [139.36903, 35.6768, 0], [139.37149, 35.67802, 0], [139.37156, 35.67806, 0],
                  [139.37324, 35.67886, 0], [139.37342, 35.67893, 0], [139.37349, 35.67897, 0],
                  [139.37367, 35.67904, 0], [139.37379, 35.6791, 0], [139.37435, 35.67933, 0],
                  [139.37496, 35.67956, 0], [139.37559, 35.67978, 0], [139.37574, 35.67982, 0],
                  [139.37575, 35.67983, 0], [139.37644, 35.68003, 0], [139.37704, 35.68018, 0],
                  [139.37807, 35.68038, 0], [139.37882, 35.68048, 0], [139.37962, 35.68055, 0],
                  [139.38035, 35.68058, 0], [139.38133, 35.68057, 0], [139.38149, 35.68056, 0],
                  [139.38155, 35.68055, 0], [139.38186, 35.68053, 0], [139.38277, 35.68044, 0],
                  [139.38314, 35.68039, 0], [139.38402, 35.68022, 0], [139.38476, 35.68005, 0],
                  [139.38611, 35.67965, 0], [139.38617, 35.67962, 0], [139.38657, 35.67949, 0],
                  [139.38657, 35.67948, 0], [139.38689, 35.67937, 0], [139.38772, 35.67905, 0],
                  [139.3894, 35.67833, 0], [139.39196, 35.67719, 0], [139.39207, 35.67715, 0],
                  [139.39218, 35.6771, 0], [139.39283, 35.67684, 0], [139.39287, 35.67683, 0],
                  [139.39327, 35.67667, 0], [139.39418, 35.67636, 0], [139.39491, 35.67614, 0],
                  [139.39542, 35.67601, 0], [139.39546, 35.67599, 0], [139.39639, 35.67576, 0],
                  [139.39797, 35.67545, 0], [139.39914, 35.67526, 0], [139.40018, 35.67512, 0],
                  [139.40134, 35.67499, 0], [139.40275, 35.67487, 0], [139.40439, 35.67477, 0],
                  [139.40613, 35.67472, 0], [139.40795, 35.67473, 0], [139.4092, 35.67477, 0],
                  [139.41051, 35.67485, 0], [139.41083, 35.67488, 0], [139.41106, 35.67489, 0],
                  [139.41211, 35.675, 0], [139.41314, 35.67514, 0], [139.41336, 35.67518, 0],
                  [139.41346, 35.67519, 0], [139.41388, 35.67526, 0], [139.41398, 35.67529, 0],
                  [139.41402, 35.67529, 0], [139.41471, 35.67543, 0], [139.41486, 35.67547, 0],
                  [139.41493, 35.67548, 0], [139.41573, 35.67568, 0], [139.41585, 35.67572, 0],
                  [139.41601, 35.67576, 0], [139.41613, 35.6758, 0], [139.4164, 35.67587, 0],
                  [139.41741, 35.6762, 0], [139.41746, 35.67623, 0], [139.41785, 35.67636, 0],
                  [139.41875, 35.67671, 0], [139.4189, 35.67676, 0], [139.42105, 35.6776, 0],
                  [139.42187, 35.67789, 0], [139.42207, 35.67795, 0], [139.42248, 35.67809, 0],
                  [139.42353, 35.67839, 0], [139.42409, 35.67853, 0], [139.42412, 35.67853, 0],
                  [139.42452, 35.67862, 0], [139.42559, 35.67879, 0], [139.42626, 35.67886, 0],
                  [139.42656, 35.67888, 0], [139.42664, 35.67889, 0], [139.4269, 35.6789, 0],
                  [139.42697, 35.67891, 0], [139.42783, 35.67892, 0], [139.42791, 35.67891, 0],
                  [139.42822, 35.67891, 0], [139.42915, 35.67885, 0], [139.42978, 35.67877, 0],
                  [139.42989, 35.67875, 0], [139.43008, 35.67873, 0], [139.43035, 35.67868, 0],
                  [139.43045, 35.67867, 0], [139.43058, 35.67864, 0], [139.43091, 35.67858, 0],
                  [139.43179, 35.67837, 0], [139.43184, 35.67835, 0], [139.43212, 35.67827, 0],
                  [139.43225, 35.67824, 0], [139.43232, 35.67821, 0], [139.43257, 35.67814, 0],
                  [139.43281, 35.67806, 0], [139.43285, 35.67804, 0], [139.43289, 35.67803, 0],
                  [139.43317, 35.67793, 0], [139.43357, 35.67777, 0], [139.43365, 35.67773, 0],
                  [139.43379, 35.67768, 0], [139.43473, 35.67724, 0], [139.43523, 35.67697, 0],
                  [139.43527, 35.67694, 0], [139.43582, 35.67663, 0], [139.43587, 35.67659, 0],
                  [139.43646, 35.67622, 0], [139.43647, 35.67621, 0], [139.43721, 35.6757, 0],
                  [139.43738, 35.67557, 0], [139.43743, 35.67554, 0], [139.4381, 35.67502, 0],
                  [139.43814, 35.67498, 0], [139.43836, 35.67481, 0], [139.43901, 35.67427, 0],
                  [139.44055, 35.6729, 0], [139.44063, 35.67282, 0], [139.44071, 35.67276, 0],
                  [139.44154, 35.672, 0], [139.44201, 35.67159, 0], [139.4422, 35.67141, 0],
                  [139.44376, 35.6701, 0], [139.4447, 35.66937, 0], [139.44516, 35.66904, 0],
                  [139.44521, 35.66901, 0], [139.4455, 35.6688, 0], [139.44634, 35.66824, 0],
                  [139.44661, 35.66808, 0], [139.44671, 35.66803, 0], [139.44726, 35.6677, 0],
                  [139.44738, 35.66764, 0], [139.44746, 35.66759, 0], [139.44826, 35.66718, 0],
                  [139.44833, 35.66715, 0], [139.44836, 35.66713, 0], [139.44863, 35.66701, 0],
                  [139.44881, 35.66692, 0], [139.44928, 35.66671, 0], [139.45037, 35.66628, 0],
                  [139.45044, 35.66626, 0], [139.4505, 35.66623, 0], [139.45068, 35.66617, 0],
                  [139.45094, 35.66607, 0], [139.45194, 35.66576, 0], [139.45196, 35.66575, 0],
                  [139.45209, 35.66572, 0], [139.4522, 35.66568, 0], [139.45317, 35.66543, 0],
                  [139.45323, 35.66542, 0], [139.45351, 35.66535, 0], [139.45371, 35.66531, 0],
                  [139.45381, 35.66528, 0], [139.45391, 35.66526, 0], [139.45393, 35.66526, 0],
                  [139.45477, 35.66509, 0], [139.4552, 35.66502, 0], [139.45521, 35.66501, 0],
                  [139.45596, 35.66489, 0], [139.45615, 35.66487, 0], [139.45633, 35.66484, 0],
                  [139.45635, 35.66484, 0], [139.45675, 35.66478, 0], [139.45886, 35.66454, 0],
                  [139.46016, 35.66443, 0], [139.4602, 35.66442, 0], [139.46072, 35.66438, 0],
                  [139.46079, 35.66437, 0], [139.46085, 35.66437, 0], [139.46324, 35.66418, 0],
                  [139.46341, 35.66416, 0], [139.46349, 35.66416, 0], [139.46377, 35.66413, 0],
                  [139.46381, 35.66413, 0], [139.46386, 35.66412, 0], [139.46561, 35.66396, 0],
                  [139.4657, 35.66394, 0], [139.46577, 35.66394, 0], [139.46583, 35.66393, 0],
                  [139.46605, 35.66391, 0], [139.46687, 35.6638, 0], [139.46691, 35.6638, 0],
                  [139.46707, 35.66378, 0], [139.46723, 35.66375, 0], [139.46737, 35.66374, 0],
                  [139.46796, 35.66365, 0], [139.46953, 35.66337, 0], [139.46975, 35.66332, 0],
                  [139.46977, 35.66332, 0], [139.4702, 35.66322, 0], [139.47042, 35.66318, 0],
                  [139.47057, 35.66314, 0], [139.47065, 35.66313, 0], [139.47188, 35.66282, 0],
                  [139.4723, 35.6627, 0], [139.47251, 35.66265, 0], [139.47329, 35.66242, 0],
                  [139.4734, 35.6624, 0], [139.47512, 35.66189, 0], [139.47517, 35.66187, 0],
                  [139.47522, 35.66186, 0], [139.47624, 35.66156, 0], [139.47626, 35.66155, 0],
                  [139.47684, 35.66139, 0], [139.47703, 35.66133, 0], [139.47713, 35.66131, 0],
                  [139.47715, 35.6613, 0], [139.47722, 35.66129, 0], [139.47768, 35.66116, 0],
                  [139.47885, 35.66088, 0], [139.47887, 35.66087, 0], [139.4799, 35.66066, 0],
                  [139.47998, 35.66065, 0], [139.48006, 35.66063, 0], [139.48015, 35.66062, 0],
                  [139.48033, 35.66058, 0], [139.48126, 35.66044, 0], [139.48139, 35.66043, 0],
                  [139.48156, 35.6604, 0], [139.4824, 35.66031, 0], [139.48388, 35.66021, 0],
                  [139.48407, 35.66021, 0], [139.48412, 35.6602, 0], [139.48524, 35.66017, 0],
                  [139.48568, 35.66017, 0], [139.48577, 35.66016, 0], [139.49308, 35.66016, 0],
                  [139.49348, 35.66021, 0], [139.49363, 35.66022, 0], [139.49539, 35.66025, 0],
                  [139.49555, 35.66029, 0], [139.49619, 35.66036, 0], [139.49647, 35.66036, 0],
                  [139.49652, 35.66035, 0], [139.49659, 35.66035, 0], [139.49666, 35.66034, 0],
                  [139.49696, 35.66033, 0], [139.49859, 35.66018, 0], [139.49867, 35.66018, 0],
                  [139.49876, 35.66017, 0], [139.4989, 35.66017, 0], [139.49903, 35.6602, 0],
                  [139.49908, 35.66022, 0], [139.49919, 35.66018, 0], [139.49921, 35.66017, 0],
                  [139.49924, 35.66016, 0], [139.49925, 35.66014, 0], [139.49927, 35.66013, 0],
                  [139.49928, 35.66012, 0], [139.49928, 35.6601, 0], [139.4993, 35.66009, 0],
                  [139.4993, 35.66006, 0], [139.49931, 35.66003, 0], [139.49932, 35.66001, 0],
                  [139.49931, 35.65959, 0], [139.49932, 35.65957, 0], [139.49943, 35.65955, 0],
                  [139.49963, 35.65953, 0], [139.49981, 35.6595, 0], [139.49998, 35.65948, 0],
                  [139.50098, 35.65929, 0], [139.50109, 35.65926, 0], [139.50142, 35.65919, 0],
                  [139.50213, 35.65901, 0], [139.50232, 35.65895, 0], [139.50292, 35.65879, 0],
                  [139.50315, 35.65872, 0], [139.5032, 35.65871, 0], [139.50352, 35.65862, 0],
                  [139.50367, 35.65857, 0], [139.50379, 35.65854, 0], [139.504, 35.65847, 0],
                  [139.50402, 35.65846, 0], [139.50518, 35.6581, 0], [139.50596, 35.65784, 0],
                  [139.50599, 35.65782, 0], [139.50647, 35.65764, 0], [139.50653, 35.65761, 0],
                  [139.50679, 35.65751, 0], [139.50692, 35.65747, 0], [139.50763, 35.6572, 0],
                  [139.5077, 35.6572, 0], [139.50931, 35.65659, 0], [139.50971, 35.65646, 0],
                  [139.50973, 35.65646, 0], [139.50998, 35.65637, 0], [139.51014, 35.65629, 0],
                  [139.51047, 35.6562, 0], [139.51047, 35.65619, 0], [139.51061, 35.65616, 0],
                  [139.51095, 35.65607, 0], [139.51121, 35.65602, 0], [139.51136, 35.65598, 0],
                  [139.51145, 35.65597, 0], [139.51154, 35.65595, 0], [139.51184, 35.6559, 0],
                  [139.51192, 35.65588, 0], [139.51199, 35.65587, 0], [139.51202, 35.65586, 0],
                  [139.51204, 35.65585, 0], [139.51207, 35.65584, 0], [139.51208, 35.65584, 0],
                  [139.51218, 35.65578, 0], [139.51226, 35.6556, 0], [139.51236, 35.65534, 0],
                  [139.51237, 35.65533, 0], [139.51242, 35.65518, 0], [139.51251, 35.65496, 0],
                  [139.51255, 35.65484, 0], [139.51259, 35.65475, 0], [139.5126, 35.65474, 0],
                  [139.51261, 35.65471, 0], [139.51263, 35.65469, 0], [139.51263, 35.65468, 0],
                  [139.51268, 35.65463, 0], [139.51271, 35.65461, 0], [139.51307, 35.65442, 0],
                  [139.5131, 35.65441, 0], [139.51312, 35.65439, 0], [139.51542, 35.65322, 0],
                  [139.51632, 35.65274, 0], [139.51638, 35.6527, 0], [139.51655, 35.65262, 0],
                  [139.51738, 35.65214, 0], [139.5174, 35.65212, 0], [139.51811, 35.65169, 0],
                  [139.51831, 35.65158, 0], [139.51928, 35.65097, 0], [139.51931, 35.65096, 0],
                  [139.52075, 35.65001, 0], [139.52082, 35.64997, 0], [139.52087, 35.64992, 0],
                  [139.52089, 35.64991, 0], [139.5214, 35.64956, 0], [139.52266, 35.64861, 0],
                  [139.52268, 35.6486, 0], [139.52326, 35.64814, 0], [139.52331, 35.64809, 0],
                  [139.52475, 35.64692, 0], [139.52488, 35.6468, 0], [139.52506, 35.64665, 0],
                  [139.5251, 35.64661, 0], [139.52534, 35.6464, 0], [139.52622, 35.64555, 0],
                  [139.52628, 35.64548, 0], [139.5263, 35.64544, 0], [139.52649, 35.6452, 0],
                  [139.52658, 35.64511, 0], [139.52671, 35.64496, 0], [139.52686, 35.64481, 0],
                  [139.5267, 35.6447, 0], [139.52663, 35.64466, 0], [139.52661, 35.64464, 0],
                  [139.52658, 35.64463, 0], [139.52581, 35.64413, 0], [139.52577, 35.64411, 0],
                  [139.52529, 35.64379, 0], [139.52523, 35.64376, 0], [139.52512, 35.64368, 0],
                  [139.52388, 35.64286, 0], [139.52373, 35.64274, 0], [139.52348, 35.64258, 0],
                  [139.52324, 35.64241, 0], [139.5235, 35.64222, 0], [139.5238, 35.64203, 0],
                  [139.52393, 35.64196, 0], [139.52399, 35.64192, 0], [139.52489, 35.64147, 0],
                  [139.52501, 35.64142, 0], [139.52504, 35.6414, 0], [139.52511, 35.64138, 0],
                  [139.52526, 35.64132, 0], [139.52789, 35.64043, 0], [139.52795, 35.64042, 0],
                  [139.52801, 35.64039, 0], [139.52867, 35.64018, 0], [139.52877, 35.64016, 0],
                  [139.5289, 35.64012, 0], [139.52963, 35.63995, 0], [139.52998, 35.63989, 0],
                  [139.53007, 35.63988, 0], [139.53018, 35.63986, 0], [139.53034, 35.63985, 0],
                  [139.53047, 35.63983, 0], [139.53066, 35.63982, 0], [139.53086, 35.6398, 0],
                  [139.53107, 35.63979, 0], [139.53118, 35.63977, 0], [139.53127, 35.63977, 0],
                  [139.53159, 35.63973, 0], [139.53168, 35.63971, 0], [139.53184, 35.63969, 0],
                  [139.53192, 35.63967, 0], [139.53199, 35.63966, 0], [139.53221, 35.63961, 0],
                  [139.5323, 35.63958, 0], [139.53391, 35.63914, 0], [139.53447, 35.63897, 0],
                  [139.53459, 35.63894, 0], [139.5346, 35.63894, 0], [139.53461, 35.63893, 0],
                  [139.53548, 35.63868, 0], [139.53563, 35.63863, 0], [139.5359, 35.63856, 0],
                  [139.53604, 35.63851, 0], [139.53626, 35.63845, 0], [139.53683, 35.63825, 0],
                  [139.53684, 35.63825, 0], [139.53767, 35.63798, 0], [139.53853, 35.63765, 0],
                  [139.53908, 35.63742, 0], [139.53924, 35.63734, 0], [139.53945, 35.63722, 0],
                  [139.53951, 35.63718, 0], [139.53961, 35.6371, 0], [139.5397, 35.63705, 0],
                  [139.53977, 35.637, 0], [139.53992, 35.63691, 0], [139.53997, 35.63687, 0],
                  [139.54004, 35.63684, 0], [139.54008, 35.63681, 0], [139.54015, 35.63677, 0],
                  [139.54026, 35.63672, 0], [139.54043, 35.63663, 0], [139.54051, 35.6366, 0],
                  [139.54059, 35.63656, 0], [139.54097, 35.6364, 0], [139.54114, 35.63634, 0],
                  [139.54123, 35.6363, 0], [139.54138, 35.63625, 0], [139.54146, 35.63623, 0],
                  [139.54155, 35.63619, 0], [139.54275, 35.63581, 0], [139.54281, 35.63578, 0],
                  [139.54439, 35.63528, 0], [139.54441, 35.63527, 0], [139.54511, 35.63507, 0],
                  [139.54554, 35.63496, 0], [139.54559, 35.63494, 0], [139.54568, 35.63492, 0],
                  [139.54587, 35.63486, 0], [139.54597, 35.63482, 0], [139.54625, 35.63473, 0],
                  [139.54737, 35.63431, 0], [139.54767, 35.63421, 0], [139.54774, 35.63418, 0],
                  [139.54783, 35.63416, 0], [139.54796, 35.63411, 0], [139.54812, 35.63407, 0],
                  [139.54827, 35.63402, 0], [139.54866, 35.63393, 0], [139.54872, 35.63391, 0],
                  [139.54878, 35.6339, 0], [139.54881, 35.63389, 0], [139.54933, 35.63378, 0],
                  [139.54935, 35.63378, 0], [139.54942, 35.63377, 0], [139.54948, 35.63375, 0],
                  [139.54958, 35.63374, 0], [139.55008, 35.63365, 0], [139.55021, 35.63364, 0],
                  [139.55038, 35.63361, 0], [139.55058, 35.63359, 0], [139.55064, 35.63359, 0],
                  [139.55067, 35.63358, 0], [139.55076, 35.63358, 0], [139.55083, 35.63357, 0],
                  [139.552, 35.6335, 0], [139.55256, 35.63349, 0], [139.55281, 35.6335, 0],
                  [139.55335, 35.6335, 0], [139.5536, 35.63351, 0], [139.55385, 35.63351, 0],
                  [139.554, 35.63352, 0], [139.55482, 35.63353, 0], [139.55502, 35.63354, 0],
                  [139.5552, 35.63354, 0], [139.55525, 35.63353, 0], [139.55553, 35.63351, 0],
                  [139.55635, 35.6334, 0], [139.55774, 35.63315, 0], [139.558, 35.63309, 0],
                  [139.55809, 35.63306, 0], [139.5583, 35.63301, 0], [139.55853, 35.63294, 0],
                  [139.55855, 35.63294, 0], [139.55894, 35.63282, 0], [139.55944, 35.63264, 0],
                  [139.55951, 35.63262, 0], [139.55966, 35.63255, 0], [139.55973, 35.63253, 0],
                  [139.56031, 35.63228, 0], [139.56047, 35.6322, 0], [139.56059, 35.63213, 0],
                  [139.56084, 35.632, 0], [139.56099, 35.63191, 0], [139.56105, 35.63188, 0],
                  [139.56111, 35.63184, 0], [139.56127, 35.63175, 0], [139.56138, 35.63167, 0],
                  [139.56145, 35.63163, 0], [139.56098, 35.63105, 0], [139.56097, 35.63103, 0],
                  [139.56075, 35.63081, 0], [139.56074, 35.63078, 0], [139.56073, 35.63077, 0],
                  [139.56072, 35.63075, 0], [139.56071, 35.63071, 0], [139.56069, 35.63068, 0],
                  [139.56067, 35.63064, 0], [139.56065, 35.63062, 0], [139.56069, 35.63054, 0]
                ]
              },
              "properties": { "name": "Directions" }
            }
          ]
        };
        
        function loadGeoJsonRoute() {
            if (!customRouteGeoJSON || !customRouteGeoJSON.features) return;
            
            routePath = [];
            routeSteps = []; 
            cumulativeDistances = [0];
            cumulativeDurations = [0]; 
            totalRouteDistance = 0;
            const bounds = new google.maps.LatLngBounds();

            customRouteGeoJSON.features.forEach(feature => {
                if (feature.geometry.type === "LineString") {
                    const coords = feature.geometry.coordinates;
                    for (let i = 0; i < coords.length; i++) {
                        const latLng = new google.maps.LatLng(coords[i][1], coords[i][0]);
                        if (routePath.length > 0) {
                            const lastPt = routePath[routePath.length - 1];
                            if (Math.abs(lastPt.lat() - latLng.lat()) < 1e-6 && Math.abs(lastPt.lng() - latLng.lng()) < 1e-6) continue;
                        }
                        routePath.push(latLng);
                        bounds.extend(latLng);
                        if (routePath.length > 1) {
                            const prev = routePath[routePath.length - 2];
                            const dist = google.maps.geometry.spherical.computeDistanceBetween(prev, latLng);
                            totalRouteDistance += dist;
                            cumulativeDistances.push(totalRouteDistance);
                        }
                    }
                }
            });
            
            // ★変更点: 全体の距離が決まった後に、全体を25分として時間を割り振る
            cumulativeDurations = cumulativeDistances.map(dist => {
                return (dist / totalRouteDistance) * TOTAL_DURATION_SECONDS;
            });

            if (routePath.length > 0) {
                bluePolyline = new google.maps.Polyline({
                    path: routePath, geodesic: true, strokeColor: '#4285F4', strokeOpacity: 0.5, strokeWeight: 8, zIndex: 1
                });
                bluePolyline.setMap(map);
                map.fitBounds(bounds);

                sliderContainer.style.display = 'block';
                document.getElementById('route-info-section').style.display = 'block';
                document.getElementById('toggle-gesture-mode').style.display = 'block';
                document.getElementById('start-tracking-button').style.display = 'block';
                
                createSlider();
            }
        }

        function performRouteSearch(destination) {
            if(!currentLatLng) { alert("現在地が不明です"); return; }
            
            const request = {
                origin: currentLatLng,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            };
            
            directionsService.route(request, (result, status) => {
                if(status === 'OK') {
                    if(bluePolyline) bluePolyline.setMap(null);
                    highlightPolylines.forEach(p => p.setMap(null));
                    
                    routePath = [];
                    routeSteps = []; 
                    cumulativeDistances = [0];
                    cumulativeDurations = [0]; 
                    totalRouteDistance = 0;
                    
                    const leg = result.routes[0].legs[0];
                    let currentGlobalIndex = 0;
                    
                    // まず距離だけ計算
                    leg.steps.forEach(step => {
                        step.startPathIndex = currentGlobalIndex;
                        
                        if(step.path) {
                           if (routePath.length === 0) routePath.push(step.path[0]);
                           
                           for (let i = 1; i < step.path.length; i++) {
                               const prev = step.path[i-1];
                               const curr = step.path[i];
                               const segDist = google.maps.geometry.spherical.computeDistanceBetween(prev, curr);
                               totalRouteDistance += segDist;
                               routePath.push(curr);
                               cumulativeDistances.push(totalRouteDistance);
                           }
                           currentGlobalIndex = routePath.length - 1;
                        }
                        step.endPathIndex = currentGlobalIndex;
                        routeSteps.push(step);
                    });
                    
                    // ★変更点: APIの所要時間は無視して、全体を25分として時間を再計算
                    cumulativeDurations = cumulativeDistances.map(dist => {
                        return (dist / totalRouteDistance) * TOTAL_DURATION_SECONDS;
                    });

                    bluePolyline = new google.maps.Polyline({
                        path: routePath, geodesic: true, strokeColor: '#4285F4', strokeOpacity: 0.5, strokeWeight: 8, zIndex: 1
                    });
                    bluePolyline.setMap(map);
                    
                    createSlider();
                    
                    const bounds = new google.maps.LatLngBounds();
                    routePath.forEach(p => bounds.extend(p));
                    map.fitBounds(bounds);
                    
                } else {
                    alert("ルート検索失敗: " + status);
                }
            });
        }

        // ★追加: 直前の位置を保存して進行方向の計算に使う変数
        let lastPositionLatLng = null;

        function updatePositionLogic(lat, lng, gpsHeading) {
            const newLatLng = new google.maps.LatLng(lat, lng);
            
            // 現在地マーカーの位置を更新
            currentLatLng = { lat: lat, lng: lng };
            currentPositionMarker.setPosition(currentLatLng);

            // ★進行方向(方位)の決定ロジック
            let headingToUse = gpsHeading;

            // GPSの方位情報(gpsHeading)がない場合、前回位置からの移動方向を計算して補完する
            if ((headingToUse === null || isNaN(headingToUse)) && lastPositionLatLng) {
                // 移動距離がわずかな場合（ノイズ）は回転させない
                const dist = google.maps.geometry.spherical.computeDistanceBetween(lastPositionLatLng, newLatLng);
                if (dist > 2) { // 2メートル以上移動した場合のみ計算
                    headingToUse = google.maps.geometry.spherical.computeHeading(lastPositionLatLng, newLatLng);
                }
            }

            // 方位が有効な場合、矢印を回転させる
            if (headingToUse !== null && !isNaN(headingToUse)) {
                const icon = currentPositionMarker.getIcon();
                icon.rotation = headingToUse;
                currentPositionMarker.setIcon(icon);
                
                // 現在地追従モード(isAutoCameraTracking)なら、地図自体も回転させる（お好みで）
                // if (isAutoCameraTracking && !isDragging) {
                //     map.setHeading(headingToUse);
                // }
            }

            // 今回の位置を「前回位置」として保存
            lastPositionLatLng = newLatLng;
        }

        function findIndexByDistance(meters) {
            if (meters <= 0) return 0;
            if (meters >= totalRouteDistance) return routePath.length - 1;
            let idx = cumulativeDistances.findIndex(d => d >= meters);
            return idx === -1 ? routePath.length - 1 : idx;
        }

        function setupDayNightMode() {
            const updateStyle = () => {
                const hour = new Date().getHours();
                map.setMapId((hour >= 18 || hour < 5) ? DARK_MAP_ID : LIGHT_MAP_ID);
            };
            updateStyle();
        }
        function setupMenu() {
            const btn = document.getElementById('menu-toggle-button');
            const menu = document.getElementById('menu-content');
            btn.addEventListener('click', () => {
                const isHidden = menu.style.display === 'none';
                menu.style.display = isHidden ? 'flex' : 'none';
                btn.textContent = isHidden ? '✕' : '☰';
            });
        }
        function setupButtons() {
            document.getElementById('toggle-search-button').addEventListener('click', () => {
                const s = document.getElementById('search-controls');
                s.style.display = (s.style.display === 'none') ? 'flex' : 'none';
            });
            
            document.getElementById('start-nav-button').addEventListener('click', () => {
                const dest = document.getElementById('destination-input').value;
                if(dest) performRouteSearch(dest);
            });
            
            document.getElementById('clear-route-button').addEventListener('click', () => {
                 if(bluePolyline) bluePolyline.setMap(null);
                 highlightPolylines.forEach(p => p.setMap(null));
                 routePath = [];
                 if(routeSlider) routeSlider.destroy();
                 routeSlider = null;
                 document.getElementById('route-info-section').style.display = 'none';
            });

            document.getElementById('demo-nav-view-button').addEventListener('click', () => {
                if (!currentLatLng) {
                    alert("現在地が取得できていません");
                    return;
                }
                map.setZoom(18);
                map.setTilt(NAV_TILT); 
                map.setCenter(currentLatLng);
                let heading = map.getHeading(); 
                map.setHeading(heading);
            });

            document.getElementById('start-tracking-button').addEventListener('click', () => {
                isTrackingMode = !isTrackingMode;
                const btn = document.getElementById('start-tracking-button');
                btn.textContent = isTrackingMode ? 'ナビ停止' : 'ナビ開始';
                btn.style.backgroundColor = isTrackingMode ? '#EA4335' : '#34A853';
                if (isTrackingMode) isAutoCameraTracking = true;
            });
            document.getElementById('tilt-up-button').addEventListener('click', () => map.setTilt(Math.min((map.getTilt() || 0) + 15, 85)));
            document.getElementById('tilt-down-button').addEventListener('click', () => map.setTilt(Math.max((map.getTilt() || 0) - 15, 0)));
        }
    </script>
    
    <script>
        const script = document.createElement('script');
        script.async = true;
        // Geometryライブラリ必須
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyBZMrPm3iUtrr4f8Bzrw6yboDilUX3aZCM&callback=initMap&v=beta&libraries=marker,places,geometry`;
        document.head.appendChild(script);
    </script>
</body>
</html>